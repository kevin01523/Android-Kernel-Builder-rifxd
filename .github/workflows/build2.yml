name: Android Kernel Build (AOSP Tools, Official Clang, Sunfish)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc curl git zip lz4 libssl-dev \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi python3 rsync flex bison \
            unzip libarchive-tools libncurses5 wget

      - name: Download AOSP build tools and toolchains (Android 13)
        run: |
          mkdir -p aosp-tools
          cd aosp-tools

          # Download platform tools
          wget -q https://dl.google.com/android/repository/platform-tools_r34.0.4-linux.zip
          unzip platform-tools_r34.0.4-linux.zip

          # Download official Android 13 clang (r450784d)
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-13.0.0_r13/clang-r450784d.tar.gz
          mkdir clang-r450784d
          tar -xzf clang-r450784d.tar.gz -C clang-r450784d

          # Download official AOSP GCC 4.9 for aarch64 and arm
          wget -q https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/android-13.0.0_r13.tar.gz -O aarch64-linux-android-4.9.tar.gz
          mkdir aarch64-linux-android-4.9
          tar -xzf aarch64-linux-android-4.9.tar.gz -C aarch64-linux-android-4.9

          wget -q https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/+archive/refs/tags/android-13.0.0_r13.tar.gz -O arm-linux-androideabi-4.9.tar.gz
          mkdir arm-linux-androideabi-4.9
          tar -xzf arm-linux-androideabi-4.9.tar.gz -C arm-linux-androideabi-4.9

          cd ..

      - name: Build Kernel
        run: |
          rm -rf out

          export KERNEL_DIR=$(pwd)/aosp-tools
          export OUT_DIR=$(pwd)/out
          export PATH="$KERNEL_DIR/platform-tools:$KERNEL_DIR/out/host/linux-x86/bin:/usr/bin:$PATH"
          export DTC_EXT=dtc
          export PATH="$KERNEL_DIR/clang-r450784d/bin:$PATH"
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE="$KERNEL_DIR/aarch64-linux-android-4.9/bin/aarch64-linux-android-"
          export CROSS_COMPILE_ARM32="$KERNEL_DIR/arm-linux-androideabi-4