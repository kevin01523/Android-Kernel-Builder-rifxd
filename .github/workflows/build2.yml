name: Android Kernel Build (AOSP Tools, Official Clang, Sunfish)

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            curl \
            ca-certificates \
            cpio \
            flex \
            git \
            lz4 \
            libssl-dev \
            libtfm-dev \
            libfl-dev \
            libncurses-dev \
            libncurses6 \
            libncursesw6 \
            python3 \
            python3-venv \
            rsync \
            unzip \
            wget \
            zstd \
            binutils-arm-linux-gnueabihf \
            gcc-arm-linux-gnueabi \
            device-tree-compiler \
            llvm \
            ccache \
            dwarves \
            lld \
            llvm-dev \
            gnupg \
            gnutls-bin \
            gperf \
            imagemagick \
            libsdl1.2-dev \
            libxml2 \
            pngcrush \
            protobuf-compiler \
            python3-protobuf \
            schedtool \
            squashfs-tools \
            xsltproc

      - name: Add swap space
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Download and set up Neutron Clang (Antman)
        run: |
          mkdir -p toolchains/neutron-clang
          cd toolchains/neutron-clang
          curl -LO "https://raw.githubusercontent.com/Neutron-Toolchains/antman/main/antman"
          chmod +x antman
          ./antman -S=11032023
          cd ../../

      - name: Patch glibc using Neutron Clang
        run: |
          cd toolchains/neutron-clang
          ./antman --patch=glibc
          cd ../..

      - name: Export Neutron Clang to PATH
        run: |
          echo "${PWD}/toolchains/neutron-clang/bin" >> $GITHUB_PATH

      - name: Clone kernel source
        run: |
          git clone --depth=1 --branch android-msm-sunfish-4.14-android13-qpr3 https://android.googlesource.com/kernel/msm kernel

      - name: Set up git identity for cherry-pick
        run: |
          cd kernel
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          cd ..

      - name: Cherry-pick proton_zf6 commit 68acd6966ac98c4610813cec759afb33015d2329
        run: |
          cd kernel
          git remote add proton_zf6 https://github.com/kdrag0n/proton_zf6.git
          git fetch proton_zf6 68acd6966ac98c4610813cec759afb33015d2329
          git cherry-pick 68acd6966ac98c4610813cec759afb33015d2329
          cd ..

      - name: Build Kernel
        run: |
          set -e
          rm -rf kernel/out
          cd kernel
          # Remove -Werror from all Makefiles before building (currently commented out)
          # find . -type f -name 'Makefile*' -exec sed -i 's/-Werror//g' {} +
          export ARCH=arm64
          export SUBARCH=arm64
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          config_path="sunfish_defconfig"
          make -j$(nproc) ARCH=$ARCH SUBARCH=$SUBARCH CC=clang \
            CROSS_COMPILE=$CROSS_COMPILE \
            CROSS_COMPILE_ARM32=$CROSS_COMPILE_ARM32 "$config_path" O=out
          echo "Compilation started..."
          make -j$(nproc) ARCH=$ARCH SUBARCH=$SUBARCH CC=clang \
            CROSS_COMPILE=$CROSS_COMPILE \
            CROSS_COMPILE_ARM32=$CROSS_COMPILE_ARM32 O=out
          cd ..

      - name: Clone AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git

      - name: Copy kernel Image to AnyKernel3
        run: |
          cp kernel/out/arch/arm64/boot/Image AnyKernel3/

      - name: Create AnyKernel3 flashable zip
        run: |
          cd AnyKernel3
          zip -r9 ../AnyKernel3-flashable.zip ./*
          cd ..

      - name: Upload AnyKernel3 flashable zip
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3-flashable
          path: AnyKernel3-flashable.zip

      - name: Upload kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: kernel/out/arch/arm64/boot/Image